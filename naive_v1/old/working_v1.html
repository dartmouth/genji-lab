<!DOCTYPE html>
<html>
<head>
    <title>Basic</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="main-content">
        <h1>Multiple Paragraphs</h1>
        <p id="P1" class="annotatable-paragraph">IN WHOSE reign was it that a woman of rather undistinguished lineage captured the heart of the Emperor and enjoyed his favor above all the other imperial wives and concubines? Certain consorts, whose high noble status gave them a sense of vain entitlement,
        </p>
        <p id="P2" class="annotatable-paragraph">His Majesty could see how forlorn she was, how often she returned to her family home. He felt sorry for her and wanted to help, and though he could scarcely afford to ignore the admonitions of his advisers, his behavior eventually became the subject of palace gossip. Ranking courtiers and attendants found it difficult to stand by and observe the troubling situation, which they viewed as deplorable. They were fully aware that a similarly ill-fated romance had thrown the Chinese state into chaos. Concern and consternation gradually spread through the court, since it appeared that nothing could be done. Many considered the relationship scandalous, so much so that some openly referred to the example of the Prize Consort Yang. The only thing that made it possible for the woman to continue to serve was the Emperor’s gracious devotion.
         </p>
        <p id="P3" class="annotatable-paragraph">The woman’s father had risen to the third rank as a Major Counselor before he died. Her mother, the principal wife of her father, was a woman of old-fashioned upbringing and character who was well trained in the customs and rituals of the court. Thus, the reputation of her house was considered in no way inferior and did not suffer by comparison with the brilliance of the highest nobility. Unfortunately, her family had no patrons who could provide political support, and after her father’s death there was no one she could rely on. In the end, she found herself at the mercy of events and with uncertain prospects.
        </p>
    </div>
    <div class="comments-sidebar">
        <h2>Comments</h2>
        <div id="comments-container"></div>
    </div>

    <script>
        document.addEventListener('mouseup', function(e) {
            const selection = window.getSelection();
            
            if (!selection.rangeCount) return;
            
            const range = selection.getRangeAt(0);
            
            // Only process if there's actually text selected
            if (selection.toString().trim().length === 0) return;

            // Get all paragraphs in the selection
            const startParagraph = range.startContainer.parentElement.closest('.annotatable-paragraph');
            const endParagraph = range.endContainer.parentElement.closest('.annotatable-paragraph');
            
            if (!startParagraph || !endParagraph) return;

            // Get all paragraphs between start and end
            const paragraphs = [];
            let currentElement = startParagraph;
            
            while (currentElement) {
                if (currentElement.classList.contains('annotatable-paragraph')) {
                    paragraphs.push(currentElement.id);
                }
                
                if (currentElement === endParagraph) break;
                currentElement = currentElement.nextElementSibling;
            }

            const selectionInfo = {
                paragraphIds: paragraphs,
                start: range.startOffset,
                end: range.endOffset,
                selectedText: selection.toString()
            };
            
            console.log('Selection Info:', selectionInfo);
        });
        function createHighlightSystem(annotations) {
            const highlights = new Map();
            
            function createHighlight(annotation) {
                const targetId = annotation.target[0].selector.value;
                const targetElement = document.getElementById(targetId);
                
                if (!targetElement) {
                    console.error(`Target element ${targetId} not found`);
                    return;
                }

                const { start, end } = annotation.target[0].selector.refinedBy;
                
                // Create comment card
                const commentCard = document.createElement('div');
                commentCard.className = 'comment-card';
                commentCard.id = `comment-${annotation.id}`;
                
                const commentHeader = document.createElement('div');
                commentHeader.className = 'comment-header';
                commentHeader.textContent = annotation.creator.split('/').pop();
                
                const commentBody = document.createElement('div');
                commentBody.className = 'comment-body';
                commentBody.textContent = annotation.body.value;
                
                commentCard.appendChild(commentHeader);
                commentCard.appendChild(commentBody);
                
                document.getElementById('comments-container').appendChild(commentCard);

                function updateHighlight() {
                    const existingContainer = targetElement.querySelector(`.highlight-container-${annotation.id}`);
                    if (existingContainer) {
                        existingContainer.remove();
                    }

                    const range = document.createRange();
                    const textNode = targetElement.firstChild;
                    
                    range.setStart(textNode, start);
                    range.setEnd(textNode, end);

                    const rects = range.getClientRects();
                    
                    const highlightContainer = document.createElement('div');
                    highlightContainer.className = `highlight-container-${annotation.id}`;
                    highlightContainer.style.position = 'absolute';
                    highlightContainer.style.pointerEvents = 'none';
                    highlightContainer.style.zIndex = '1';
                    highlightContainer.style.top = '0';
                    highlightContainer.style.left = '0';
                    
                    Array.from(rects).forEach(rect => {
                        const highlight = document.createElement('div');
                        highlight.style.position = 'absolute';
                        highlight.style.backgroundColor = 'yellow';
                        highlight.style.opacity = '0.5';
                        highlight.style.left = `${rect.left - targetElement.getBoundingClientRect().left}px`;
                        highlight.style.top = `${rect.top - targetElement.getBoundingClientRect().top}px`;
                        highlight.style.width = `${rect.width}px`;
                        highlight.style.height = `${rect.height}px`;
                        highlight.style.pointerEvents = 'none';  // Changed from 'auto' to 'none'
                        highlight.style.userSelect = 'none';     // Add this to prevent highlight selection
                        
                        // We still want to handle hover events, but now we need to use the parent element
                        highlightContainer.addEventListener('mouseenter', () => {
                            commentCard.classList.add('highlighted');
                        });
                        
                        highlightContainer.addEventListener('mouseleave', () => {
                            commentCard.classList.remove('highlighted');
                        });
                        
                        highlightContainer.appendChild(highlight);
                    });

                    targetElement.appendChild(highlightContainer);
                }

                updateHighlight();

                const resizeObserver = new ResizeObserver(() => {
                    updateHighlight();
                });

                resizeObserver.observe(targetElement);
                
                return {
                    update: updateHighlight,
                    cleanup: () => {
                        resizeObserver.disconnect();
                        const container = targetElement.querySelector(`.highlight-container-${annotation.id}`);
                        if (container) container.remove();
                        commentCard.remove();
                    }
                };
            }

            // Initialize all annotations
            function initialize() {
                // Clean up any existing highlights
                highlights.forEach(highlight => highlight.cleanup());
                highlights.clear();

                // Create new highlights
                annotations.forEach(annotation => {
                    const highlight = createHighlight(annotation);
                    highlights.set(annotation.id, highlight);
                });
            }

            // Handle window resize for all highlights
            window.addEventListener('resize', () => {
                highlights.forEach(highlight => highlight.update());
            });

            return {
                initialize,
                cleanup: () => {
                    highlights.forEach(highlight => highlight.cleanup());
                    highlights.clear();
                }
            };
        }

        // Sample annotations array
        const annotations = [
            {
                "@context": "http://www.w3.org/ns/anno.jsonld",
                "id": "comment1",
                "type": "Annotation",
                "creator": "http://example.org/user1",
                "body": {
                    "type": "TextualBody",
                    "value": "I guess there were lots of them?",
                    "format": "text/html",
                    "language": "en"
                },
                "target": [{
                    "id": "comment1/target",
                    "type": "Text",
                    "source": "http://example.org/page1",
                    "selector": {
                        "type": "FragmentSelector",
                        "value": "P1",
                        "refinedBy": {
                            "type": "TextPositionSelector",
                            "start": 131,
                            "end": 174
                        }
                    }
                }]
            },
            {
                "@context": "http://www.w3.org/ns/anno.jsonld",
                "id": "comment2",
                "type": "Annotation",
                "creator": "http://example.org/user2",
                "body": {
                    "type": "TextualBody",
                    "value": "This is a comment on the second paragraph",
                    "format": "text/html",
                    "language": "en"
                },
                "target": [{
                    "id": "comment2/target",
                    "type": "Text",
                    "source": "http://example.org/page1",
                    "selector": {
                        "type": "FragmentSelector",
                        "value": "P2",
                        "refinedBy": {
                            "type": "TextPositionSelector",
                            "start": 10,
                            "end": 50
                        }
                    }
                }]
            }
        ];

        window.addEventListener('load', () => {
            const highlightSystem = createHighlightSystem(annotations);
            highlightSystem.initialize();
        });
    </script>
</body>
</html>