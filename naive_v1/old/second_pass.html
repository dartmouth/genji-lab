<!DOCTYPE html>
<html>
<head>
    <title>Basic</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: grid;
            grid-template-columns: 1fr 300px;
            min-height: 100vh;
        }

        .main-content {
            padding: 20px;
        }

        .comments-sidebar {
            background-color: #f5f5f5;
            padding: 20px;
            border-left: 1px solid #ddd;
        }

        #P1 {
            position: relative;
        }

        .comment-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 16px;
            margin-bottom: 16px;
            transition: background-color 0.2s ease;
        }

        .comment-card.highlighted {
            background-color: #fff3cd;
        }

        .comment-header {
            font-weight: bold;
            color: #666;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .comment-body {
            color: #333;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="main-content">
        <h1>Paragraph stub</h1>
        <p id="P1">
            IN WHOSE reign was it that a woman of rather undistinguished lineage captured the heart of the Emperor and enjoyed his favor above all the other imperial wives and concubines? Certain consorts, whose high noble status gave them a sense of vain entitlement,
        </p>
    </div>
    <div class="comments-sidebar">
        <h2>Comments</h2>
        <div id="comments-container"></div>
    </div>

    <script>
        function createHighlight(annotation) {
            const targetId = annotation.target[0].selector.value;
            const targetElement = document.getElementById(targetId);
            
            if (!targetElement) {
                console.error('Target element not found');
                return;
            }

            const { start, end } = annotation.target[0].selector.refinedBy;
            
            // Create comment card
            const commentCard = document.createElement('div');
            commentCard.className = 'comment-card';
            commentCard.id = `comment-${annotation.id}`;
            
            const commentHeader = document.createElement('div');
            commentHeader.className = 'comment-header';
            commentHeader.textContent = annotation.creator.split('/').pop(); // Extract username from URI
            
            const commentBody = document.createElement('div');
            commentBody.className = 'comment-body';
            commentBody.textContent = annotation.body.value;
            
            commentCard.appendChild(commentHeader);
            commentCard.appendChild(commentBody);
            
            document.getElementById('comments-container').appendChild(commentCard);

            function updateHighlight() {
                const existingContainer = targetElement.querySelector('.highlight-container');
                if (existingContainer) {
                    existingContainer.remove();
                }

                const range = document.createRange();
                const textNode = targetElement.firstChild;
                
                range.setStart(textNode, start);
                range.setEnd(textNode, end);

                const rects = range.getClientRects();
                
                const highlightContainer = document.createElement('div');
                highlightContainer.className = 'highlight-container';
                highlightContainer.style.position = 'absolute';
                highlightContainer.style.pointerEvents = 'none';
                highlightContainer.style.zIndex = '1';
                highlightContainer.style.top = '0';
                highlightContainer.style.left = '0';
                
                Array.from(rects).forEach(rect => {
                    const highlight = document.createElement('div');
                    highlight.style.position = 'absolute';
                    highlight.style.backgroundColor = 'yellow';
                    highlight.style.opacity = '0.5';
                    highlight.style.left = `${rect.left - targetElement.getBoundingClientRect().left}px`;
                    highlight.style.top = `${rect.top - targetElement.getBoundingClientRect().top}px`;
                    highlight.style.width = `${rect.width}px`;
                    highlight.style.height = `${rect.height}px`;
                    highlight.style.pointerEvents = 'auto';
                    
                    highlight.addEventListener('mouseenter', () => {
                        commentCard.classList.add('highlighted');
                    });
                    
                    highlight.addEventListener('mouseleave', () => {
                        commentCard.classList.remove('highlighted');
                    });
                    
                    highlightContainer.appendChild(highlight);
                });

                targetElement.appendChild(highlightContainer);
            }

            updateHighlight();

            const resizeObserver = new ResizeObserver(() => {
                updateHighlight();
            });

            resizeObserver.observe(targetElement);
            window.addEventListener('resize', updateHighlight);

            return {
                update: updateHighlight,
                cleanup: () => {
                    resizeObserver.disconnect();
                    window.removeEventListener('resize', updateHighlight);
                    const container = targetElement.querySelector('.highlight-container');
                    if (container) container.remove();
                    commentCard.remove();
                }
            };
        }

        const annotation = {
            "@context": "http://www.w3.org/ns/anno.jsonld",
            "id": "comment1",
            "type": "Annotation",
            "creator": "http://example.org/user1",
            "body": {
                "type": "TextualBody",
                "value": "I guess there were lots of them?",
                "format": "text/html",
                "language": "en"
            },
            "target": [{
                "id": "comment1/target",
                "type": "Text",
                "source": "http://example.org/page1",
                "selector": {
                    "type": "FragmentSelector",
                    "value": "P1",
                    "refinedBy": {
                        "type": "TextPositionSelector",
                        "start": 131,
                        "end": 174
                    }
                }
            }]
        };

        window.addEventListener('load', () => {
            createHighlight(annotation);
        });
    </script>
</body>
</html>